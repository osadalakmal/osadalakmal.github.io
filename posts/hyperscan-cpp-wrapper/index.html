<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Using Hyperscan regex library in C++">
<title>Hyperscan C&#43;&#43; Wrapper</title>

<link rel='canonical' href='https://osada.blog/posts/hyperscan-cpp-wrapper/'>

<link rel="stylesheet" href="/scss/style.min.946cca6c6259ef94ac55abfae7c7bf3291ea3ed5eea17ef77500b257217c6710.css"><meta property='og:title' content="Hyperscan C++ Wrapper">
<meta property='og:description' content="Using Hyperscan regex library in C++">
<meta property='og:url' content='https://osada.blog/posts/hyperscan-cpp-wrapper/'>
<meta property='og:site_name' content='Osada Blog ‚Äì Thoughts on Software Engineering, Programming, Systems, and Life'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='c&#43;&#43;' /><meta property='article:tag' content='cpp' /><meta property='article:tag' content='regex' /><meta property='article:tag' content='intel' /><meta property='article:tag' content='hyperscan' /><meta property='article:tag' content='wrapper' /><meta property='article:published_time' content='2021-12-19T22:16:45&#43;05:30'/><meta property='article:modified_time' content='2021-12-19T22:16:45&#43;05:30'/><meta property='og:image' content='https://osada.blog/posts/hyperscan-cpp-wrapper/Hyperspace_falcon.webp' />
<meta name="twitter:site" content="@osadaparanaliyanage">
    <meta name="twitter:creator" content="@osadaparanaliyanage"><meta name="twitter:title" content="Hyperscan C++ Wrapper">
<meta name="twitter:description" content="Using Hyperscan regex library in C++"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://osada.blog/posts/hyperscan-cpp-wrapper/Hyperspace_falcon.webp' />
    <link rel="shortcut icon" href="/img/favicon.ico" />

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-0KDQ9KLJCX"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-0KDQ9KLJCX');
        }
      </script>
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    <img src="https://osada.blog/profile.jpg" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                </a>
                
                    <span class="emoji">üßë‚Äçüíª</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Osada Blog ‚Äì Thoughts on Software Engineering, Programming, Systems, and Life</a></h1>
            <h2 class="site-description">Musings about coding, systems, fatherhood and everything in between.</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/posts/' >
                
                
                
                <span>All Posts</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags' >
                
                
                
                <span>Tags</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories' >
                
                
                
                <span>Categories</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/hyperscan-cpp-wrapper/">
                <img src="/posts/hyperscan-cpp-wrapper/Hyperspace_falcon_hu_d8889ac7c7ade989.webp"
                        srcset="/posts/hyperscan-cpp-wrapper/Hyperspace_falcon_hu_d8889ac7c7ade989.webp 800w, /posts/hyperscan-cpp-wrapper/Hyperspace_falcon_hu_7e117a7238024d8d.webp 1600w"
                        width="800" 
                        height="340" 
                        loading="lazy"
                        alt="Featured image of post Hyperscan C&#43;&#43; Wrapper" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/programming/" >
                Programming
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/hyperscan-cpp-wrapper/">Hyperscan C&#43;&#43; Wrapper</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            Using Hyperscan regex library in C&#43;&#43;
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Dec 19, 2021</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <blockquote>
<p>(or why using the phrase &ldquo;C/C++&rdquo; is crime against programming)</p></blockquote>
<div class="toc">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#being-a-c-library-in-a-c-world">Being a C library in a C++ World</a></li>
    <li><a href="#why-c-is-still-being-used">Why C is still being used</a></li>
    <li><a href="#c-is-nice-but-c-is-nicer">C is nice but C++ is nicer</a></li>
    <li><a href="#implementing-a-c-wrapper-for-hyperscan">Implementing a C++ Wrapper for Hyperscan</a></li>
    <li><a href="#takeaways">Takeaways</a></li>
  </ul>
</nav>
  </div>
  
<h2 id="being-a-c-library-in-a-c-world">Being a C library in a C++ World
</h2><p>This weekend I was looking at a regex library written by intel called <a class="link" href="https://github.com/intel/hyperscan/"  target="_blank" rel="noopener"
    >hyperscan</a>. I had needed to use a regex library that was performant  and easy to use. I needed the library to use all the new hardware features such as new instructions such as AVX2 and AVX512. This library was the best one I came across.</p>
<p>It has support for block mode for bounded data and also supports streaming mode for unbounded or streaming data. It uses graph decomposition and hybrid automata based approach to match the data and uses the <a class="link" href="https://en.wikipedia.org/wiki/Ragel"  target="_blank" rel="noopener"
    >ragel library</a> for parsing the regex. It also uses SIMD instructions and has a lot of optimizations as is to be expected from a CPU vendors library.</p>
<h2 id="why-c-is-still-being-used">Why C is still being used
</h2><p>Now, given all that had transpired during the last decade from Heartbleed to POODLE, you might be forgiven for asking why anyone in their right frame of mind, would implement a regex library in C. But the fact of the matter is for performant idiomatic code that is portable, nothing comes as close as C. Rust is a promising language and I wish that all the very best and a bright future. But it still has a long ways to go to grab the same mind share as C. The biggest thing is that C is such a simple language.</p>
<p>It is based on a very simple mental modal and once you have mastered it, it pays dividends over and above. It has barely changed over the time I first learned it around 14 years ago. And this durability is a huge plus in the practical world. This means that for projects that will stay relatively stable, C is a great choice.</p>
<h2 id="c-is-nice-but-c-is-nicer">C is nice but C++ is nicer
</h2>


<figure>
    
        <img src="https://osada.blog/posts/hyperscan-cpp-wrapper/A12SR71.webp"/> <figcaption>
                
                    <h4>For every nice thing, there is a nicer thing - A12 vs SR71</h4>
                
                
            </figcaption></figure>

<p>As a user of C++ primarily for 12 years and counting, It brings lots of nice things to the table. Talking about C++ is a topic in and of itself and this margin is definitely not enough large enough to contain those notes. But for the purpose of explaining this post, I will cover the highlights of what it provides over C.</p>
<p>The biggest of these is the ability to do easier resource management. <a class="link" href="https://en.cppreference.com/w/cpp/language/raii"  target="_blank" rel="noopener"
    >RAII</a> is a very simple but very powerful concept. Along with automatically called destructors, this concept makes it very easy to enforce clean up of resources.</p>
<p>The &ldquo;dot method&rdquo; of programming as I like to call it, is a very convenient way to experiment quickly. Basically the idea is that you include the main header file for the library you are experimenting with, then you instantiate whatever seems to be the most relevant class for what you want to achieve. And finally you type the object name and then press dot and wait for autocompletion of the IDE to kick in. Assuming the library author was a sensible person, you would be off to the races at this point. You would have everything you need to do right there and it will be a matter of calling the right methods with the right parameters.</p>
<p>Now this is not how you would necessarily do the actual development for the production code but this is very useful in prototyping and testing.</p>
<p>Another nice thing about C++ is it&rsquo;s capability to hide unwanted complexity. And make sure the code moves only within the parameters set by the library. Enum classes and other features introduced in C++11 is the main driver for this functionality.</p>
<h2 id="implementing-a-c-wrapper-for-hyperscan">Implementing a C++ Wrapper for Hyperscan
</h2><p>With all that in mind, let&rsquo;s get down to business of creating the wrapper. Lets start with the header file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">HyperScanDatabase</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">typedef</span> <span class="n">match_event_handler</span> <span class="n">EventHandler</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">enum</span> <span class="k">class</span> <span class="nc">ScanMode</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BLOCK</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">STREAM</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="n">HyperScanDatabase</span><span class="p">(</span><span class="n">ScanMode</span> <span class="n">scanMode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">virtual</span> <span class="o">~</span><span class="n">HyperScanDatabase</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">addPattern</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nf">scan</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">EventHandler</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span> <span class="n">m_patterns</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">m_flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">m_ids</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">m_compiled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">ScanMode</span> <span class="n">m_scanMode</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hs_database_t</span><span class="o">*</span> <span class="n">m_database</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">hs_scratch_t</span><span class="o">*</span> <span class="n">m_scratch</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>The first thing to note is I am converting the configuration options and parameter types to C++ equivalents. This can be as simple as changing integer flags to enum classes and up lifting function pointers in to C++ typedefs. Or they can be more elaborate ones where we cover up return codes with an exception hierarchy, change C data structures to C++ STL ones and so on. The important thing is that you keep the interface of the wrapper within the C++ realms and remove the &ldquo;C&rdquo; ness of the interface.</p>
<p>Then note that the internal data structures are all C++ ones, even when ultimately they will be passed to the C code. <code>m_patterns</code> for example is a vector of char pointers. In C world this would become a two dimensional dynamically allocated array of char pointers. But in C++ world, it is a vector of char pointers. The difference being that memory management is far easier on the vector. Note that I couldn&rsquo;t use a vector of vectors because there is no guarantee in C++ about contiguousness of nested vectors.</p>
<p>A virtual destructor because we are holding resources that need to be freed and a state variable for holding internal state is also present.</p>
<p>The methods themselves are very simple. The construction of the object only requires you to know if you are processing a stream or block of characters. Then a single method for adding a pattern for matching which returns a unique id for the pattern. Then a method scanning the data and calling the event handler for each match.</p>
<p>Switching over to the implementation it looks like following</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&#34;hs_wrapper.h&#34;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span>
</span></span><span class="line"><span class="cl">    <span class="nf">compile</span><span class="p">(</span><span class="n">HyperScanDatabase</span><span class="o">::</span><span class="n">ScanMode</span> <span class="n">scanMode</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span> <span class="n">patterns</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">flags</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">ids</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hs_database</span><span class="o">**</span> <span class="n">database</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">hs_scratch</span><span class="o">**</span> <span class="n">scratch</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">hs_compile_error_t</span><span class="o">*</span> <span class="n">compileError</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">hs_compile_multi</span><span class="p">(</span><span class="o">&amp;</span><span class="n">patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                           <span class="o">&amp;</span><span class="n">flags</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                           <span class="o">&amp;</span><span class="n">ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                           <span class="n">patterns</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                           <span class="p">(</span><span class="n">scanMode</span> <span class="o">==</span> <span class="n">HyperScanDatabase</span><span class="o">::</span><span class="n">ScanMode</span><span class="o">::</span><span class="n">STREAM</span>
</span></span><span class="line"><span class="cl">                              <span class="o">?</span> <span class="nl">HS_MODE_STREAM</span>
</span></span><span class="line"><span class="cl">                              <span class="p">:</span> <span class="n">HS_MODE_BLOCK</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                           <span class="k">nullptr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">database</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="o">&amp;</span><span class="n">compileError</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;ERROR: Unable to compile patterns: %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">compileError</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hs_free_compile_error</span><span class="p">(</span><span class="n">compileError</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hs_free_database</span><span class="p">(</span><span class="o">*</span><span class="n">database</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">hs_alloc_scratch</span><span class="p">(</span><span class="o">*</span><span class="n">database</span><span class="p">,</span> <span class="n">scratch</span><span class="p">)</span> <span class="o">!=</span> <span class="n">HS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;ERROR: Unable to allocate scratch space. Exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">hs_free_database</span><span class="p">(</span><span class="o">*</span><span class="n">database</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">// anonymous namespace
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="n">HyperScanDatabase</span><span class="o">::</span><span class="n">HyperScanDatabase</span><span class="p">(</span><span class="n">ScanMode</span> <span class="n">scanMode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="o">:</span> <span class="n">m_scanMode</span><span class="p">(</span><span class="n">scanMode</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">m_database</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">,</span> <span class="n">m_scratch</span><span class="p">(</span><span class="k">nullptr</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">HyperScanDatabase</span><span class="o">::~</span><span class="n">HyperScanDatabase</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">m_database</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hs_free_database</span><span class="p">(</span><span class="n">m_database</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">m_scratch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">hs_free_scratch</span><span class="p">(</span><span class="n">m_scratch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="nl">pattern</span> <span class="p">:</span> <span class="n">m_patterns</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">delete</span><span class="p">[]</span> <span class="n">pattern</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="n">HyperScanDatabase</span><span class="o">::</span><span class="n">addPattern</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">pattern</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">char</span><span class="o">*</span> <span class="n">d_pattern</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="n">strncpy</span><span class="p">(</span><span class="n">d_pattern</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_patterns</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">d_pattern</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_flags</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">m_ids</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">m_ids</span><span class="p">.</span><span class="n">back</span><span class="p">()</span><span class="o">++</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">m_patterns</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span>
</span></span><span class="line"><span class="cl"><span class="n">HyperScanDatabase</span><span class="o">::</span><span class="n">scan</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">data1</span><span class="p">,</span> <span class="n">size_t</span> <span class="n">dataSize</span><span class="p">,</span> <span class="n">EventHandler</span> <span class="n">eventHandler</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">HS_SUCCESS</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_compiled</span><span class="p">)</span> <span class="n">compile</span><span class="p">(</span><span class="n">m_scanMode</span><span class="p">,</span> <span class="n">m_patterns</span><span class="p">,</span> <span class="n">m_flags</span><span class="p">,</span> <span class="n">m_ids</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_database</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">m_scratch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">hs_scan</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">         <span class="n">m_database</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">dataSize</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m_scratch</span><span class="p">,</span> <span class="n">eventHandler</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">))</span> <span class="o">!=</span>
</span></span><span class="line"><span class="cl">      <span class="n">HS_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">fprintf</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;ERROR: Unable to scan input buffer. rc = %d. Exiting.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>All the usual suspects really. Try to follow the best practices. Everything from <a class="link" href="https://www.oreilly.com/library/view/effective-modern-c/9781491908419/"  target="_blank" rel="noopener"
    >Effective Modern C++11</a> to <a class="link" href="https://herbsutter.com/gotw/"  target="_blank" rel="noopener"
    >Guru of the week</a>. But in particular pay attention to the fact we hid the implementation of the compile function from the header in an anonymous namespace. This is something that I have seen almost all the C++ newbies, specially ones that started out with Java make. Those functions do not need to be part of the header file. Even if you make it private, it ends up polluting the namespace and needing recompiles of all the translation units including this header for no real gain. And no, you do not have to test that. The whole point of TDD is to test the unit - i.e. the interface you defined in the header. The public interface of the class can and should be tested and the <code>compile</code> function will get tested while you do that. You don&rsquo;t need to write a specific test for that function.</p>
<p>Also note that we delegate resource management to the constructor and destructor as much as possible. The user of the class should not have to worry about freeing the resources. Obviously resource holding classes should not ideally be value semantic classes, so copying etc should be prevented. So in hindsight I should have used something like <a class="link" href="https://en.cppreference.com/w/cpp/language/rule_of_three"  target="_blank" rel="noopener"
    >rule of three</a> and defined a copy constructor and assignment operator as well. So strike one for me :)</p>
<h2 id="takeaways">Takeaways
</h2><p>In general the first thing that I instinctively do when I have to use a non-trivial C library is to look for a C++ wrapper. It is much easier to work with a C++ interface and not have to worry about manual resource management. This pattern of creating C++ wrappers go back to when we had to use OpenSSL in one of my previous jobs and we ended up writing a pretty comprehensive C++ wrapper for that. In case you have to do that for your work, try to make sure that you never ever leak the resource management details to outside. The moment you do that, you lose all advantage that C++ gives you.</p>
<p>Make sure that your wrappers public interface is independent from the underlying C libraries. Redefine enums to enum classes, use narrower types, use types with custom validation - whatever you do, define your own interfaces since that will allow you to customize the internal behavior to your hearts content as well upgrade or modify the underlying C library without having to change the clients of your library.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/c&#43;&#43;/">C&#43;&#43;</a>
        
            <a href="/tags/cpp/">Cpp</a>
        
            <a href="/tags/regex/">Regex</a>
        
            <a href="/tags/intel/">Intel</a>
        
            <a href="/tags/hyperscan/">Hyperscan</a>
        
            <a href="/tags/wrapper/">Wrapper</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Osada Blog ‚Äì Thoughts on Software Engineering, Programming, Systems, and Life
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
