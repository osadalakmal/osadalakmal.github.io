<!DOCTYPE html>
<html lang="en-gb" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='We consider how to approach implementation of feature flags in a careful '>
<title>Valkey: The New Redis Alternative</title>

<link rel='canonical' href='https://osadalakmal.github.io/posts/valkey-the-new-redis-alternative/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='Valkey: The New Redis Alternative'>
<meta property='og:description' content='We consider how to approach implementation of feature flags in a careful '>
<meta property='og:url' content='https://osadalakmal.github.io/posts/valkey-the-new-redis-alternative/'>
<meta property='og:site_name' content='Curiously Recurring Thoughts in Programming'>
<meta property='og:type' content='article'><meta property='article:section' content='Posts' /><meta property='article:tag' content='software-architecture' /><meta property='article:tag' content='cloud' /><meta property='article:tag' content='was' /><meta property='article:published_time' content='2024-11-17T13:29:22&#43;00:00'/><meta property='article:modified_time' content='2024-11-17T13:29:22&#43;00:00'/><meta property='og:image' content='https://osadalakmal.github.io/posts/valkey-the-new-redis-alternative/valkey.png' />
<meta name="twitter:site" content="@osadaparanaliyanage">
    <meta name="twitter:creator" content="@osadaparanaliyanage"><meta name="twitter:title" content="Valkey: The New Redis Alternative">
<meta name="twitter:description" content="We consider how to approach implementation of feature flags in a careful "><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://osadalakmal.github.io/posts/valkey-the-new-redis-alternative/valkey.png' />
    <link rel="shortcut icon" href="/img/favicon.ico" />

  
    
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-0KDQ9KLJCX"></script>
      <script>
        var doNotTrack = false;
        if ( false ) {
          var dnt = (navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack);
          var doNotTrack = (dnt == "1" || dnt == "yes");
        }
        if (!doNotTrack) {
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-0KDQ9KLJCX');
        }
      </script>
    
  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    <img src="https://osada.blog/profile.jpg" width="300" height="300" class="site-logo" loading="lazy" alt="Avatar">
                
                </a>
                
                    <span class="emoji">üßë‚Äçüíª</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">Curiously Recurring Thoughts in Programming</a></h1>
            <h2 class="site-description">Musings about coding, systems, fatherhood and everything in between.</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/posts/' >
                
                
                
                <span>All Posts</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        
        <li >
            <a href='/tags' >
                
                
                
                <span>Tags</span>
            </a>
        </li>
        
        
        <li >
            <a href='/categories' >
                
                
                
                <span>Categories</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://osadalakmal.github.io/" selected></option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>Dark Mode</span>
                </li>
            
        </div>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/posts/valkey-the-new-redis-alternative/">
                <img src="/posts/valkey-the-new-redis-alternative/valkey_hu93b6af6bb15f4eca0c823e296e00d3a8_33462_800x0_resize_box_3.png"
                        srcset="/posts/valkey-the-new-redis-alternative/valkey_hu93b6af6bb15f4eca0c823e296e00d3a8_33462_800x0_resize_box_3.png 800w, /posts/valkey-the-new-redis-alternative/valkey_hu93b6af6bb15f4eca0c823e296e00d3a8_33462_1600x0_resize_box_3.png 1600w"
                        width="800" 
                        height="450" 
                        loading="lazy"
                        alt="Featured image of post Valkey: The New Redis Alternative" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/software-architecture/" >
                Software-Architecture
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/valkey-the-new-redis-alternative/">Valkey: The New Redis Alternative</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            We consider how to approach implementation of feature flags in a careful 
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 17, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    11 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="what-is-redis">What is Redis?</h2>
<p>Redis (Remote Dictionary Server) is an open-source, in-memory data structure store that functions as a database, cache, and message broker. Known for its high performance and versatility, Redis supports low-latency operations crucial for real-time applications. At its core, Redis organizes data as key-value pairs but extends its functionality with advanced data structures (ADTs), streaming capabilities, and persistence options.</p>
<p>Redis offers rich data types, including strings, lists, sets, sorted sets, hashes, bitmaps, and hyperloglogs. These enable complex operations like leaderboard maintenance, set intersections, or approximate cardinality estimation. Redis Streams further enhance its capabilities, enabling real-time data processing and message queuing with features like consumer groups, automatic message acknowledgment, and ordered, append-only data logs.</p>
<p>Redis also supports data durability through mechanisms like snapshots (RDB files) and append-only file (AOF) logs. Snapshots provide periodic states of the database, while AOF logs persist each write operation. These features make Redis suitable for both ephemeral and long-term data storage. With additional functionalities like replication, clustering, Lua scripting, and pub/sub messaging, Redis remains a critical component in modern web architectures.</p>
<h2 id="a-brief-history-of-redis">A Brief History of Redis</h2>
<p>Redis was created in 2009 by Salvatore Sanfilippo to address the performance limitations of disk-based databases for his Italian startup. Redis quickly gained traction for its innovative, memory-first design and simple API, becoming a go-to tool for applications requiring fast and reliable data access.</p>
<p>Redis transitioned to open-source early in its development, encouraging community contributions. By 2015, Redis Labs (now Redis Inc.) became the commercial steward of the project, adding enterprise-grade features and cloud-based services. Today, Redis powers platforms ranging from small startups to tech giants like Twitter and Airbnb.</p>
<p>In 2018, Redis Inc. introduced the Server Side Public License (SSPL) for certain modules to prevent cloud providers from monetizing Redis without contributing back. This sparked debates within the open-source ecosystem about software freedom. Around this time, the community-driven Valkey project emerged as an open-source alternative to Redis under a permissive BSD license, addressing concerns over licensing restrictions while retaining Redis compatibility.<br>
Valkey on AWS</p>
<p>When Valkey was announced, major PaaS providers rapidly adopted it. AWS, in particular, introduced a Valkey-based caching option with two notable characteristics:</p>
<ul>
<li>Pricing Advantage: AWS provides a 20% discount on Valkey caches compared to Redis OSS caches. AWS even promotes Valkey through console notifications encouraging users to switch, with text like &ldquo;Create clusters for as little as $6 per month.&rdquo;</li>
<li>Serverless Only: Unlike traditional serverful Redis offerings, AWS Valkey is exclusively available as a serverless service. While I am usually skeptical of AWS&rsquo;s serverless and managed options‚Äîsuch as Aurora Serverless, which can be prohibitively expensive for consistent workloads‚Äîthis approach intrigued me enough to explore further.</li>
</ul>
<p>AWS offers Valkey as an engine in its ElastiCache service. So provisioning a valkey cluster is largely similar to the process of getting any other elasticache cluster. Below is a sample AWS CDK script for provisioning a Valkey cache:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Create the User for the valkey cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CfnUser</span><span class="p">.</span><span class="na">Builder</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ServerlessCacheUserDefault&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">engine</span><span class="p">(</span><span class="s">&#34;redis&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userId</span><span class="p">(</span><span class="s">&#34;valkey-user&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userName</span><span class="p">(</span><span class="s">&#34;valkey-user&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">noPasswordRequired</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">generatedUserIds</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getUserId</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">generatedUsers</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="n">user</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Now create the user group to include the user in</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">userGroup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CfnUserGroup</span><span class="p">.</span><span class="na">Builder</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ServerlessCacheUserGroup&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">engine</span><span class="p">(</span><span class="s">&#34;redis&#34;</span><span class="p">)</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userGroupId</span><span class="p">(</span><span class="s">&#34;valkey-cache-usergroup&#34;</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userIds</span><span class="p">(</span><span class="n">generatedUserIds</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">userGroup</span><span class="p">.</span><span class="na">getNode</span><span class="p">().</span><span class="na">addDependency</span><span class="p">(</span><span class="n">generatedUsers</span><span class="p">.</span><span class="na">toArray</span><span class="p">(</span><span class="n">CfnUser</span><span class="o">[]</span><span class="p">::</span><span class="k">new</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Now for the security group for the elasticache cluster</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">serverlessCacheSG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SecurityGroup</span><span class="p">.</span><span class="na">Builder</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ServerlessCacheSecurityGroup&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">securityGroupName</span><span class="p">(</span><span class="s">&#34;valkey-cache-sg&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">vpc</span><span class="p">(</span><span class="n">mainVPC</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Allow traffic in to default redis/valkey port</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">serverlessCacheSG</span><span class="p">.</span><span class="na">addIngressRule</span><span class="p">(</span><span class="n">Peer</span><span class="p">.</span><span class="na">ipv4</span><span class="p">(</span><span class="n">cidrIpRange</span><span class="p">.</span><span class="na">getValueAsString</span><span class="p">()),</span><span class="w"> </span><span class="n">Port</span><span class="p">.</span><span class="na">tcp</span><span class="p">(</span><span class="n">6379</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="c1">// Build the actual cache</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="n">serverlessCache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CfnServerlessCache</span><span class="p">.</span><span class="na">Builder</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="s">&#34;ServerlessCache&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">serverlessCacheName</span><span class="p">(</span><span class="s">&#34;shared-cache&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">engine</span><span class="p">(</span><span class="s">&#34;valkey&#34;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">userGroupId</span><span class="p">(</span><span class="n">userGroup</span><span class="p">.</span><span class="na">getUserGroupId</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">securityGroupIds</span><span class="p">(</span><span class="n">List</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">serverlessCacheSG</span><span class="p">.</span><span class="na">getSecurityGroupId</span><span class="p">()))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">subnetIds</span><span class="p">(</span><span class="n">Vpc</span><span class="p">.</span><span class="na">getPrivateSubnets</span><span class="p">().</span><span class="na">stream</span><span class="p">().</span><span class="na">map</span><span class="p">(</span><span class="n">ISubnet</span><span class="p">::</span><span class="n">getSubnetId</span><span class="p">).</span><span class="na">toList</span><span class="p">())</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="n">serverlessCache</span><span class="p">.</span><span class="na">getNode</span><span class="p">().</span><span class="na">addDependency</span><span class="p">(</span><span class="n">userGroup</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>from the top, we start setting up users for the valkey cache, then a user group for it. The documentation for each can be found <a class="link" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_elasticache.CfnUser.html"  target="_blank" rel="noopener"
    >here</a> and <a class="link" href="https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_elasticache.CfnUserGroup.html"  target="_blank" rel="noopener"
    >here</a>. For more information you can refer to their Cloudformation counterparts <a class="link" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticache-user.html"  target="_blank" rel="noopener"
    >here</a> and <a class="link" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-elasticache-usergroup.html"  target="_blank" rel="noopener"
    >here</a>.After that is done, we create the security group and add a ingress rule allowing incoming connections to server port 6379 which is the default for valkey. Then finally we build the actual cache using the user, usergroup and security group.</p>
<h2 id="how-valkey-compares-with-serverful-redis">How Valkey compares with serverful redis.</h2>
<p>I was already benchmarking a couple of different approaches for one our applications and had a benchmarking script lying around that I used for this not-so-scientific benchmarking process. The salient points of the benchmarking points are as follows.</p>
<ol>
<li>I wanted to see what the best way to store relatively large blobs of json efficiently in redis were. Note that the best practice for storing values on redis is to break large values down to smaller parts. But that is not possible in this case. We are basically utilizing elasticache as a shared (amongst instances of a micro-service) look aside cache.</li>
<li>The alternatives I was testing were
<ol>
<li>JSON capability via <a class="link" href="https://github.com/RedisJSON/RedisJSON"  target="_blank" rel="noopener"
    >redisJSON</a>.</li>
<li>Just plain old string after converting from in memory representation of JSON</li>
<li>Compressing in order to make it more efficient while in transit and storage. For compression algorithm I was weighing between using <a class="link" href="https://github.com/lz4/lz4"  target="_blank" rel="noopener"
    >LZ4</a> and <a class="link" href="https://github.com/facebook/zstd"  target="_blank" rel="noopener"
    >Zstd</a> and opted for zstd in the end.</li>
</ol>
</li>
<li>I used faker because just generating random values does not really reflect the characteristics of the data we store. I have aspirations to turn this in to general tool for stressing our databases and caches for given traffic patterns and this might become useful in that sense.</li>
<li>We are not including time for compressing the data as I didn&rsquo;t include the time for JSON encoding the data either. Ideally we would measure Wall time from data being in-memory to</li>
<li>The workloads that we typically see in our workloads tend to be rather write heavy. This is to be expected since the personalized content that we serve are really one use for the most part. Therefore I set the read/write split of the workload at 20/80 for this run of the benchmarking script.</li>
</ol>
<details>
	<summary>Click to Expand: Python script for benchmarking redis/valkey for our use-case</summary>
	<div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#!/usr/bin/env python3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">redis</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">faker</span> <span class="kn">import</span> <span class="n">Faker</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">string</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">zstandard</span> <span class="k">as</span> <span class="nn">zstd</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Configs</span>
</span></span><span class="line"><span class="cl"><span class="n">HOST</span> <span class="o">=</span> <span class="s1">&#39;127.0.0.1&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">PORT</span> <span class="o">=</span> <span class="mi">7000</span>
</span></span><span class="line"><span class="cl"><span class="n">NUM_KEYS</span> <span class="o">=</span> <span class="mi">2000</span>
</span></span><span class="line"><span class="cl"><span class="n">OPERATIONS</span> <span class="o">=</span> <span class="mi">10000</span>
</span></span><span class="line"><span class="cl"><span class="n">READ_PERCENTAGE</span> <span class="o">=</span> <span class="mf">0.2</span>
</span></span><span class="line"><span class="cl"><span class="n">WRITE_PERCENTAGE</span> <span class="o">=</span> <span class="mf">0.8</span>
</span></span><span class="line"><span class="cl"><span class="n">VALUE_SIZE_KB</span> <span class="o">=</span> <span class="mi">150</span>
</span></span><span class="line"><span class="cl"><span class="n">KEY_LENGTH</span> <span class="o">=</span> <span class="mi">50</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_json_value</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">fake_data</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;address&#34;</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">address</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;email&#34;</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">email</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;phone&#34;</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">phone_number</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;company&#34;</span><span class="p">:</span> <span class="n">faker</span><span class="o">.</span><span class="n">company</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">fake_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">json_data</span><span class="p">[:</span><span class="n">VALUE_SIZE_KB</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_random_key</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="n">length</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">compress_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">cctx</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">ZstdCompressor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">compressed_data</span> <span class="o">=</span> <span class="n">cctx</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">compressed_data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">decompress_data</span><span class="p">(</span><span class="n">compressed_data</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">dctx</span> <span class="o">=</span> <span class="n">zstd</span><span class="o">.</span><span class="n">ZstdDecompressor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">dctx</span><span class="o">.</span><span class="n">decompress</span><span class="p">(</span><span class="n">compressed_data</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">benchmark_json</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">read_ops_json</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_ops_json</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">num_reads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OPERATIONS</span> <span class="o">*</span> <span class="n">READ_PERCENTAGE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_writes</span> <span class="o">=</span> <span class="n">OPERATIONS</span> <span class="o">-</span> <span class="n">num_reads</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;JSON.SET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_reads</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;JSON.GET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">read_ops_json</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_writes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">json_value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;JSON.SET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">json_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">write_ops_json</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;JSON Workload benchmark completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Read operations: </span><span class="si">{</span><span class="n">read_ops_json</span><span class="si">}</span><span class="s2">, Write operations: </span><span class="si">{</span><span class="n">write_ops_json</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">benchmark_string</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">read_ops_string</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_ops_string</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">num_reads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OPERATIONS</span> <span class="o">*</span> <span class="n">READ_PERCENTAGE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_writes</span> <span class="o">=</span> <span class="n">OPERATIONS</span> <span class="o">-</span> <span class="n">num_reads</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:string&#34;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_reads</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:string&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">read_ops_string</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_writes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">json_value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:string&#34;</span><span class="p">,</span> <span class="n">json_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">write_ops_string</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;String Workload benchmark completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Read operations: </span><span class="si">{</span><span class="n">read_ops_string</span><span class="si">}</span><span class="s2">, Write operations: </span><span class="si">{</span><span class="n">write_ops_string</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">benchmark_compressed_string</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">read_ops_string</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">write_ops_string</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">num_reads</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OPERATIONS</span> <span class="o">*</span> <span class="n">READ_PERCENTAGE</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_writes</span> <span class="o">=</span> <span class="n">OPERATIONS</span> <span class="o">-</span> <span class="n">num_reads</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">keys</span><span class="p">,</span> <span class="n">values</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">value</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">compressed_value</span> <span class="o">=</span> <span class="n">compress_data</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:binary&#34;</span><span class="p">,</span> <span class="n">compressed_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_reads</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">compressed_data</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:binary&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">compressed_data</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">decompressed_data</span> <span class="o">=</span> <span class="n">decompress_data</span><span class="p">(</span><span class="n">compressed_data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">read_ops_string</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_writes</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">key</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="n">json_value</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">json_value</span><span class="p">:</span> 
</span></span><span class="line"><span class="cl">            <span class="n">compressed_value</span> <span class="o">=</span> <span class="n">compress_data</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:binary&#34;</span><span class="p">,</span> <span class="n">compressed_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">            <span class="n">write_ops_string</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;String Workload (Compressed) benchmark completed in </span><span class="si">{</span><span class="n">duration</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Read operations: </span><span class="si">{</span><span class="n">read_ops_string</span><span class="si">}</span><span class="s2">, Write operations: </span><span class="si">{</span><span class="n">write_ops_string</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">PORT</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ssl</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ssl_cert_reqs</span><span class="o">=</span><span class="s2">&#34;none&#34;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s2">&#34;rms-tyga&#34;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&#34;password12345678&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">faker</span> <span class="o">=</span> <span class="n">Faker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">keys</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">NUM_KEYS</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span> <span class="o">=</span> <span class="s2">&#34;rms-tyga:&#34;</span> <span class="o">+</span> <span class="n">generate_random_key</span><span class="p">(</span><span class="n">KEY_LENGTH</span><span class="o">-</span><span class="mi">9</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">json_value</span> <span class="o">=</span> <span class="n">generate_json_value</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span><span class="o">.</span><span class="n">execute_command</span><span class="p">(</span><span class="s1">&#39;JSON.SET&#39;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="s1">&#39;$&#39;</span><span class="p">,</span> <span class="n">json_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">    <span class="n">client</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&#34;:string&#34;</span><span class="p">,</span> <span class="n">json_value</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">benchmark_json</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">benchmark_string</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">benchmark_compressed_string</span><span class="p">()</span>
</span></span></code></pre></div></div>
</details>

<p>The results from running this script against a t4g.medium based 2 node, 1 shard redis cluster was as follows</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">(</span><span class="n">redis</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="n">benchmark</span><span class="p">)</span> <span class="err">‚ûú</span>  <span class="n">redis</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="n">benchmark</span> <span class="o">./</span><span class="n">benchmark</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">JSON</span> <span class="n">Workload</span> <span class="n">benchmark</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">386.04</span> <span class="n">seconds</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">Write</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">8000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">String</span> <span class="n">Workload</span> <span class="n">benchmark</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">381.14</span> <span class="n">seconds</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">Write</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">8000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">String</span> <span class="n">Workload</span> <span class="p">(</span><span class="n">Compressed</span><span class="p">)</span> <span class="n">benchmark</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">381.77</span> <span class="n">seconds</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">Write</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">8000</span>
</span></span></code></pre></div><p>Same script when run against the Serverless valkey cache yeilds</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">(</span><span class="n">redis</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="n">benchmark</span><span class="p">)</span> <span class="err">‚ûú</span>  <span class="n">redis</span><span class="o">-</span><span class="n">json</span><span class="o">-</span><span class="n">benchmark</span> <span class="o">./</span><span class="n">benchmark</span><span class="o">.</span><span class="n">py</span>
</span></span><span class="line"><span class="cl"><span class="n">JSON</span> <span class="n">Workload</span> <span class="n">benchmark</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">324.97</span> <span class="n">seconds</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">Write</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">8000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">String</span> <span class="n">Workload</span> <span class="n">benchmark</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">326.84</span> <span class="n">seconds</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">Write</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">8000</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="ne">String</span> <span class="n">Workload</span> <span class="p">(</span><span class="n">Compressed</span><span class="p">)</span> <span class="n">benchmark</span> <span class="n">completed</span> <span class="ow">in</span> <span class="mf">324.98</span> <span class="n">seconds</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Read</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">Write</span> <span class="n">operations</span><span class="p">:</span> <span class="mi">8000</span>
</span></span></code></pre></div><p>So as can be seen valkey performs roughly 15% better than the serverful version. Now, the fact that it is a burstable VM may have something to do with it, but note that the CPU usage did not go beyond 5% the whole time I ran the benchmark for the redis version. So I do not think it had a huge impact. The scaling seems pretty good as well. According to docs from cold it can scale up to 30K ECPU operations for a single shard and for read replicas can scale up to 90K.</p>
<p>Note that using redisJSON has more advantages than pure speed. You also get ability to operate on the JSON using operators that understand the JSON structure. For example you can use <a class="link" href="https://github.com/json-path/JsonPath"  target="_blank" rel="noopener"
    >JSONPath</a> queries on the data and fetch partial fragments from the data if needed.</p>
<h3 id="side-note-on-compression-algorithms-for-use-with-data-storagetransfer">Side note on compression algorithms for use with data storage/transfer.</h3>
<p>I tried out a couple of different options for the compression algorithm here starting with standard gzip. What I found out was the unless you were using a newer standard that optimized for faster compression/decompression, it was really hard to get the compression to make a difference.</p>
<p>The options I tried were</p>
<ol>
<li>ZLib for GZip - This is included in the standard library for python and very easy to use. But since decompression seems highly costly, it took the scores way higher than it should have. So I abandoned that option.</li>
<li>LZ4 - This is the first of a new breed of compression formats that was introduced to make inline compression of data possible for large streams of data. Created by google and widely adopted since then, this improved matters quite a bit. Note that it optimizes for compression speed and not size. It is also quite light on the CPU usage compared to others.</li>
<li>Zstd - This is the newest kid on the block from what I know and was created at facebook. This is what I ended up using and game me the best results out of the three. This algorithm gives much better compression ratios than lz4 at the cost of more CPU usage. So as always, it is a tradeoff.</li>
</ol>
<p>If you are interested in these algorithms and are considering which one to use, you can find an interesting discussion where author of Zstd shows up on hacker news <a class="link" href="https://news.ycombinator.com/item?id=19678115"  target="_blank" rel="noopener"
    >here</a>.</p>
<h2 id="valkey-pricing">Valkey pricing</h2>
<p>You would have noticed the unit ECPU in the paragraph above and as is customary for AWS this is a very complicated term that seems to be used for billing for it&rsquo;s serverless option. In simple terms a GET or a SET of a 1 KB data blob will take 1 ECPU. For commands that have higher CPU usage like HMGET, the CPU usage dimension becomes higher and for HMGET specifically it is 3 times the base case. And the pricing is set by the dimension that is the highest. Thus if you do an operation that GETs 2 KB of data using HMGET you get charged 3 ECPUs.</p>
<p>This all makes for a rather complex pricing structure as you can imagine but if you use redis servers today, a rough idea of pricing can be had by looking at the no of GET/SET/etc operations and your traffic in and our in your metrics. In our cases the cache nodes were quite underutilized so there was an upside to using valkey in pricing as well.</p>
<h2 id="should-i-use-valkey">Should I use Valkey?</h2>
<p>So for AWS, GCP and Azure it is a no brainer that everyone should switch to Valkey. But should you? For me that depends. Redis is a very very complex beast nowadays. It is no longer a memcached replacement only and has everything from ADTs, probabilistic data structures, streaming to vector storage. And as always the best practice is to compare your use case amongst the two options. Start by creating a sample workload that simulates your real workload and then run it on both infrastructure and compare the results so you have an apples to apples comparison. Don&rsquo;t forget to take in to account all the aspects like cost and performance.</p>
<p>What about the serverless aspect? Is it worth it to avoiding sys admin work on the nodes and engine when you are running on your own provisioned servers? So far that does not seem like a huge task. RDS upgrades are by far a bigger headache with trying to convince DMS and pg_replication to play nicely and making sure to move the bits of the schema that DMS won&rsquo;t move. Redis by comparison seems so simple but it <em>is</em> another thing to do.</p>
<p>All in all, this seems like something that is worth evaluating at least so give it a go. Only thing I am wondering where else the same drama will play out now that the VCs are coming for their pound of flesh and the OSS startup are pulling the draw bridges up?</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/software-architecture/">Software-Architecture</a>
        
            <a href="/tags/cloud/">Cloud</a>
        
            <a href="/tags/was/">Was</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/posts/just-use-json/">
        
        
            <div class="article-image">
                
                    <img src="/this-is-engineering.jpg" loading="lazy" data-key="" data-hash="/this-is-engineering.jpg"/>
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Just Use Json</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/what-does-your-engineering-team-value/">
        
        
            <div class="article-image">
                <img src="/posts/what-does-your-engineering-team-value/this-is-engineering.a3dd82628a25230ffdadeda35bdfd3ad_hu5459c0360c2b0cb7a147d2df0eb350ca_3913476_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post What Determines Your Engineering Organization&#39;s Culture"
                        
                        data-hash="md5-o92CYoolIw/9re2jW9/TrQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">What Determines Your Engineering Organization&#39;s Culture</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/compromises-and-moving-forward/">
        
        
            <div class="article-image">
                <img src="/posts/compromises-and-moving-forward/_hu3d03a01dcc18bc5be0e67db3d8d209a6_340035_054bd0a570003bdd0abb2a7d73613ba3.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Compromises and Moving Forward"
                        
                        data-hash="md5-vQwlLlKHUKPsHsCkdxl1Rg==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Compromises and Moving Forward</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/lies-damn-lies-and-engineering-metrics/">
        
        
            <div class="article-image">
                <img src="/posts/lies-damn-lies-and-engineering-metrics/banner.0bc831eb335243b0daa883230eaa187d_hu3d03a01dcc18bc5be0e67db3d8d209a6_381384_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Lies, Damn Lies and Engineering Metrics"
                        
                        data-hash="md5-C8gx6zNSQ7DaqIMjDqoYfQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Lies, Damn Lies and Engineering Metrics</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/posts/stakeholders-and-alliances/">
        
        
            <div class="article-image">
                <img src="/posts/stakeholders-and-alliances/working-together.cdd55ee70263d7fd74671851e3e4bb7b_hu3d03a01dcc18bc5be0e67db3d8d209a6_574874_250x150_fill_q75_box_smart1.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Stakeholder Management and Alliance Forming"
                        
                        data-hash="md5-zdVe5wJj1/10ZxhR4&#43;S7ew==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Stakeholder Management and Alliance Forming</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
        2025 Curiously Recurring Thoughts in Programming
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
